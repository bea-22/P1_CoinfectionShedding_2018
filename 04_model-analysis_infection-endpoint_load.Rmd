---
title: "03_model-analysis_infection-endpoint_load"
author: "Bryony Allen"
date: "09/05/2019"
output: word_document
---

```{r questions, include=FALSE,}
#Can pathogen load (Bd GE or ranavirus viral load) be explained by pathogen exposure scenario? 
   # Do coinfection treatment groups have higher pathogen loads? 
  
#Does pathogen load (Bd GE or ranavirus viral load) vary with host species?
#Does pathogen load (Bd GE or ranavirus viral load) vary predictably for different levels of pathogen exposure & species?

```


```{r packages, include=FALSE, warning=FALSE, error=FALSE, message=FALSE}
# Install & load in required packages 

# for tidying data  
library(dplyr)
# library(tidyr)
# library(tibble)

# for plotting 
library(ggplot2) 
library(lattice)
library(ggridges)

# for stats 
library(binom)
# library(purr)  # purr guidance > for evaluating models http://ijlyttle.github.io/isugg_purrr/presentation.html#(1) 
# library(broom)   # broom summarizes key information about models in tidy tibble()s >> https://github.com/tidymodels/broom
```

# Part 1: Import data 

> **N.B.**   At the moment this code chuck reads in a .csv file with endpoint infection data, originally compiled in excel and then cleaned in "02_tidy_data-qpcr"script. In the future you will read in the .csv file of merged qPCR outputs (created, checked and cleaned in "02_tidy_data-qpcr"script) and experiment metadata (checked and cleaned in "02_tidy_data-metadata"script). 

<br>
```{r import data, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
data.endpoint <- read.csv('data/02_clean-data.csv') 
    data.endpoint$ExperimentNo <-  as.factor(data.endpoint$ExperimentNo)   # makes experiment number a factor 

glimpse(data.endpoint)   #check how the dataset has imported (aka whether it has the data type right)  
```

# Part 2: Visualise Bd endpoint infection load data 
```{r graph labels, include=FALSE, warning=FALSE, error=FALSE, message=FALSE}
# make label vectors to use in plots
sp.labs <- c(Bb = "Bufo bufo", Rt = "Rana temporaria", Am = "Alytes muletensis")
exp.labs <- c("1" = "Bufo bufo I", "2" = "Bufo bufo II", "3" = "Rana temporaria", "4" = "Alytes muletensis","5" = "Alytes muletensis II")
expos.labs <- c("1" = "Bd", "2" = "Rv", "3" = "Bd-Rv", "4"="Rv-Bd")
```

Here I only include Bd infection loads over the 0.1 GE threshold. 

```{r Bd Bd boxplot, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.cap= "Fig.1. Boxplot of the endpoint Bd load for each treatment group across the three host species. Bd load is quantified as genomic equivalents (GE) where 1 GE represents 1 Bd zoospore. Where the black dots represent each sample and the red diamond the mean for that group.", fig.width=16, fig.height=8}

plot.Bd.GE.sp <- data.endpoint %>% 
   filter((Bd.endpoint.status=='1' & Bd.endpoint.GE > 0.1))  %>%   # filter so its just Bd infection that are over the threshold 
      ggplot(aes(interaction(x= Treatment, ExperimentNo), y= Bd.endpoint.GE, fill = ExperimentNo)) +
        geom_boxplot() +
        stat_summary(fun.y="mean", geom="point", shape=23, size=3, fill="red") +    # adds a marker for mean - for normally distibuted data the median and mean will match closely 
        geom_jitter(width = 0.05) +   # adds the data points 
        scale_y_log10() +  # logs the axis 
        scale_x_discrete(labels=c("Bd", "Bd>Rv", "Rv>Bd","Bd", "Bd>Rv", "Rv>Bd","Bd", "Bd>Rv", "Rv>Bd", "Bd", "Bd>Rv", "Rv>Bd", "Bd")) +
        xlab("Treatment Group") +
        ylab("Bd load\n(GE)") +
        theme(axis.title.y = element_text(angle=0, size=14), legend.text = element_text(face = "italic")) + 
        scale_fill_grey(start=1, end=.5, labels=exp.labs) +
        theme_bw()
        
 plot.Bd.GE.sp + theme(legend.key=element_blank()) +theme(legend.text = element_text(face = "italic")) +theme(axis.text.x = element_text(angle=30, hjust=1,vjust=1)) + theme(axis.title = element_text(size=16))
```


<br>

```{r distribution Bd GE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.cap= "Fig. 2a. The distribution of Bd load expressed as GE from endpoint tissue samples.", fig.width=16, fig.height=6}

data.endpoint %>%     # ridge plot to see distribution of data  
    filter((Bd.endpoint.status=='1' & Bd.endpoint.GE > 0.1))  %>%  ggplot(aes(Bd.endpoint.GE, Treatment)) +
      geom_density_ridges(
                      jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
                      vline_size = 1, vline_color = "red",
                      point_size = 0.4, point_alpha = 1,
                      position = position_raincloud(adjust_vlines = TRUE)
          ) + theme_ridges()
```

<br>

... and when Bd load is logged 

```{r log distribution Bd GE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.cap= "Fig. 2b. The logged distribution of Bd load expressed as genomic equivalents (GE), where one GE is equivalent to a single zoospore, from endpoint tissue samples.", fig.width=16, fig.height=6}
data.endpoint %>%     # ridge plot to see distribution of data  
    filter((Bd.endpoint.status=='1' & Bd.endpoint.GE > 0.1))  %>%  ggplot(aes(log(Bd.endpoint.GE), Treatment)) +
      geom_density_ridges(
                      jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
                      vline_size = 1, vline_color = "red",
                      point_size = 0.4, point_alpha = 1,
                      position = position_raincloud(adjust_vlines = TRUE)
          ) + theme_ridges()
```


<br>


# Part 3: Apply models to **Bd** Endpoint Infection Load

GLM's where    
<br>
    response variable = endpoint load [continuous; ]   
  <br>
    explanatory variable(s) = Treatment [categorical, levels = 4] & Species [categorical, levels = 5]

<br>
  
  
**N.B.**  I use ExperimentNo as a proxy for species where

Experiment No. | Species              | total Bd zsp's   | min. temp. (^o^C) | max. temp. (^o^C)
---------- |------------------------- | -------------| -------------|------------- 
1 | *Bufo bufo* I          | 3,675,000    | 16.6        | 23.5     
2 | *Bufo bufo* II         | 1,443,750   | 16.7        | 27.6    
3 | *Rana temporaria*     | 2,336,250     | 16.7         | 27.6    
4 | *Alytes muletensis* I  | 472,500      | 15     | 16.6 
5 | *Alytes muletensis* II | 294,759      | 15     | 16.6 

... as this also accounts for Bd dose and room temperature variation between experiments. 


## Part 3a: Endpoint Infection Status: **Bd** 

Here I create a dataframe with only individuals that am infected with Bd, at a level over the detection threshold of 0.1GE. Note that *Alytes muletensis* II have been removed as they only have one treatment group (Bd only). 

<br>
```{r Bd load df, results='hide', warning=FALSE, error=FALSE, message=FALSE}
Bd.load <- data.endpoint %>%
  filter(!ExperimentNo=='5')  %>%   # removal of Alytes babies
  filter((Bd.endpoint.status=='1' & Bd.endpoint.GE > 0.1))  %>% 
  select(ID, Species, ExperimentNo, Scenario, Treatment, Bd.endpoint.status, Bd.endpoint.GE) 

droplevels(Bd.load)
```

### Model Selection:  

Choosing a error structure family. I decided to do this with a semi-maximal model to help the fitting as much as possible. 

1. gaussian distribution with data log transformed  

```{r Bd log gaussian}
Bd.load2.1 <- glm(log(Bd.endpoint.GE) ~ Treatment + ExperimentNo, data=Bd.load, family= "gaussian")
summary(Bd.load2.1)   #AIC = 609.11  #Residual deviance:  320.39  on 166  degrees of freedom

par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Bd.load2.1)
```

2.  Gamma distribution
> This error structure is suitable for continous, positive, right skewed data where variance is near-constant on the log-scale

```{r Bd Gamma }
# Gamma distribution
Bd.load2.3 <- glm(Bd.endpoint.GE ~ Treatment + ExperimentNo, data=Bd.load, family=Gamma())
summary(Bd.load2.3)   #AIC = 1633.2  #Residual deviance: 225.26  on 166 degrees of freedom

par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Bd.load2.3)
```

The diagnostic plots are fine 

- residual vs. fitted do show patterning meaning the variance is non-consistent
- QQ plot is really good 
- scale-location the scatter of the residuals decreases with the fitted values 
- residual deviance is better than log(Bd load) with gaussian 
- AIC is not great 

4. Gamma distribution with log-link
> Apparent it is quite common to fit a log-link with a Gamma error structure ... so that is left-skewed? 

```{r Gamma log link}
Bd.load2.4 <- glm(Bd.endpoint.GE ~ Treatment + ExperimentNo, data=Bd.load, family="Gamma"(link='log'))
summary(Bd.load2.4)   #AIC = 1629.9  #Residual deviance: 221.67  on 166  degrees of freedom

par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Bd.load2.4)
```

**Conclusion** Gamma with log-link as "the most appropriate link function is one which produces minimum residual deviance"

### Model Comparison

The four models (all using Gamma with log-link structure)
```{r Bd load glm}

Bd.load1 <- glm(log(Bd.endpoint.GE) ~ Treatment * ExperimentNo, data=Bd.load, family="Gamma"(link='log'))

Bd.load2 <- glm(log(Bd.endpoint.GE) ~ Treatment + ExperimentNo, data=Bd.load, family="Gamma"(link='log'))

Bd.load3 <- glm(log(Bd.endpoint.GE) ~ Treatment, data=Bd.load, family="Gamma"(link='log'))

Bd.load4 <- glm(log(Bd.endpoint.GE) ~ ExperimentNo, data=Bd.load, family="Gamma"(link='log'))
```

?? **QUESTION** should I change the `test = ` to better reflect the data type? 

```{r Bd load model comparison}

anova(Bd.load2, Bd.load4, test="Chisq") # compares Trt and Sp to just Sp 

anova(Bd.load2, Bd.load3, test="Chisq") # compares Trt and Sp to just Trt 

anova(Bd.load1, Bd.load2, test="Chisq") # compare more complex model to one with interaction 

```
ANOVA 1: suggests we should reject the more complex model (Treatment + ExperimentNo) in favour for just the model with ExperimentNo only  (pvalue = 0.3633)

ANOVA 2: suggests we should favour the more complex model (Treatment + ExperimentNo) over the model with Treatment only  (pvalue = < .001)  as adding ExperimentNo did lead to significantly improved fit 
ANOVA 3: shows adding a interaction term between Treatment and ExperimentNo did not significantly imporve fit (p-value = 0.5595)

**Conclusion**: we should choose the model with just ExperimentNo (aka species) 


### Model Fit: 

To see the fitted values from a regression object (the values of the dependent variable predicted by the model), access the ```fitted.values``` attribute from a regression object with ````$fitted.values```  Look at https://bookdown.org/ndphillips/YaRrr/linear-regression-with-lm.html


```{r Bd fitted values, echo=FALSE, fig.cap= "Fig. 6. Plot of relationship between the fitted values from the model and the true data values."}

Bd.load$glm.fit <- Bd.load4$fitted.values  # add logisitic fitted values back to the dataframe as a new col

plot(x = Bd.load$Bd.endpoint.GE, y = Bd.load$glm.fit,  # 
     xlab = "True Values",
     ylab = "Model Fitted Values",
     main = "Regression fits of Bd load")

abline(b = 1, a = 0)   # values should fall around this line!

```


> **N.B.** Values should fall around the line but they seem to be clumped by ExperimentNo. 

### Model Plotting:   
To plot the model you need a range of values for which to produce fitted values. Then use the ```predict()``` function to create the model for all the values. ```predict()``` gives you the predicted values based on your (fitted) linear model, the argument type="response" will give you the predicted probabilities 


```{r Bd - glm - predicted values, include=TRUE, warning=FALSE, error=FALSE, message=FALSE}
Bd.load4 <- glm(log(Bd.endpoint.GE) ~ ExperimentNo, data=Bd.load, family=gaussian)

# create a dataframe of "new" data 
newdat <- expand.grid(ExperimentNo=c("1", "2", "3", "4", "5"),Treatment=c("Bd", "Bd-Rv", "Rv-Bd"))

# predict the value/result of the new data using the glm
newdat <-cbind(newdat, predict(object = Bd.load4,   # the model 
                               newdata=newdat, se=TRUE, type="response", print.matrix=T))  # dataframe of new data 
newdat

expl.var <- c(1:3) # chose the range for the x-axis (Experiment No.)
exp.labs <- c("1" = "Bufo bufo I", "2" = "Bufo bufo II", "3" = "Rana temporaria", "4" = "Alytes muletensis I", "5" = "Alytes muletensis II")

newdat1<- subset(newdat, ExperimentNo== "1")    # need to subset the data so you can plot each seperatly 
newdat2<- subset(newdat, ExperimentNo=="2")
newdat3<- subset(newdat, ExperimentNo=="3")
newdat4<- subset(newdat, ExperimentNo=="4")
newdat5<- subset(newdat, ExperimentNo=="5")
```


```{r Bd - glm - plot, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.cap= "Fig. 7. Probability of Bd infection load (GE) predicted by model"}

Bd.load.predict <- ggplot(newdat, aes(x= expl.var, y= fit, color=ExperimentNo)) +       # plot model estimates, color= the data you subsetted by
  geom_line(data = newdat1, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat1
  geom_errorbar(data = newdat1, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1)  +      # error bars for subset newdat1
  geom_line(data = newdat2, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat2
  geom_errorbar(data = newdat2, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1)  +      # error bars for subset newdat2
  geom_line(data = newdat3, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat3
  geom_errorbar(data = newdat3, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1)  +      # error bars for subset newdat3
  geom_line(data = newdat4, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat4
  geom_errorbar(data = newdat4, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1) +       # error bars for subset newdat4
  geom_line(data = newdat5, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat5
  geom_errorbar(data = newdat5, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1) +       # error bars for subset newdat5
    scale_x_continuous(breaks=seq(1:3),labels=c("Bd", "Bd-Rv", "Rv-Bd")) +   # sets the breaks at 1,2 and 3 which correspond to the label names
  ggtitle("glm(Bd.endpoint.load ~ ExperimentNo,family = gaussian)") 
      
Bd.load.predict <- Bd.load.predict + 
  ylab("Bd load predictions\n(fit)") +            
  xlab("Treatment Group") +
  scale_fill_discrete(labels=exp.labs) +  # still not working!!!
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

Bd.load.predict

#  ggsave("figs/04_Bd_load-predict.png", plot= Bd.load.predict, device=NULL)
 
```


The Bd load predictions are interesting... 
The two *Bufo bufo* experiments have the highest predicted loads, and reflect the Bd dosed (1 = 3,675,000 zsp's; 2 = 1,443,750 zsp's). 
The *Alytes muletensis* are also clumped, here it's either a reflection of Bd dose (4 = 472,500 zsp's; 5 = 294,759 zsp's), which was scaled to container size, or development stage. If development stage, we see the larger, more developed tadpoles having low loads than the babies. 

A reminder, just in case ... 

Experiment No. | Species              | total Bd zsp's   | min. temp. (^o^C) | max. temp. (^o^C)
---------- |------------------------- | -------------| -------------|------------- 
1 | *Bufo bufo* I          | 3,675,000    | 16.6        | 23.5     
2 | *Bufo bufo* II         | 1,443,750   | 16.7        | 27.6    
3 | *Rana temporaria*     | 2,336,250     | 16.7         | 27.6    
4 | *Alytes muletensis* I  | 472,500      | 15     | 16.6 
5 | *Alytes muletensis* II | 294,759      | 15     | 16.6 



### Models Checks 

Here I check the two best models.

#### Maximal Model: Species + Treamtent (no interaction)
Fit the most complex model first, with the main effects for ExperimentNo. and Treatment. 

Look at the estimates of the coefficients using ```summary()```
```{r Bd - glm - checks1, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
# Bd.load2 <- glm(log(Bd.endpoint.GE) ~ Treatment + ExperimentNo, data=Bd.load, family=gaussian)
summary(Bd.load2)   # Residual deviance: 337.15  on 190 df   AIC: 680.91
```

Residual deviance should be the same as the residual degrees of freedom but is way larger, indicating overdispersion (unexplained variation in the response). 

```{r Bd - glm - checks1 plot, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE }
par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Bd.load2)
```


#### Simplified Model: Species 
Now fit a simpler model has an with only ExperimentNo.  
```{r Bd - bi.glm - checks2, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
# Bd.load4 <- glm(log(Bd.endpoint.GE) ~ ExperimentNo, data=Bd.load, family=gaussian)
summary(Bd.load4)   # Residual deviance: 340.74  on 192 df   AIC: 679
```

```{r Bd - glm - checks2 plot, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Bd.load4)
```

<br>
The AIC (assessing parameters contributions to the model) suggests you don't gain much explanatory power by lossing a parameter (Treatment). 


############################################

# Part 4: Visualise Rv endpoint infection load data 

**N.B.**  At the moment there are 3 samples missing EBF3N qPCR data so as a temporary fix I have averaged the EBF3N score for all the samples and used that to calculate a rough viral load for these 3 samples

For the plots below I only plot Rv infection loads over 0 and filter out one extremely high Rv viral load (greater than 2000).

```{r boxplot Rv viral load, echo=FALSE, fig.cap= "Fig.3. Boxplot of the endpoint Ranaviral load for each treatment group across the three host species. Viral load has been normalised using Leung et al.'s (2017) method. The black dots represent each sample.", fig.width=16, fig.height=8}

plot.Rv.load.sp <- data.endpoint %>% 
 filter(Rv.endpoint.load > 0 & !Rv.endpoint.load > 2000) %>%  # filtering out the extremely high Rv viral load so that we can see the data better 
  ggplot(aes(x = interaction(Treatment, ExperimentNo), y= Rv.endpoint.load, fill = ExperimentNo)) + 
        geom_boxplot() +
        #stat_summary(fun.y="mean", geom="point", shape=23, size=3, fill="red") +    
        geom_jitter(width = 0.05) +   # adds the data points       
        xlab("Treatment Group") +
        ylab("Rv viral load\n (log)") +
        theme(legend.text = element_text(face = "italic")) + 
        scale_fill_grey(start=1, end=.5, labels=exp.labs) +
        scale_x_discrete(labels=c("Bd>Rv", "Rv>Bd", "Bd>Rv", "Rv","Rv>Bd", "Bd>Rv", "Rv>Bd","Bd>Rv","Rv","Rv>Bd")) +
        labs(fill="Species")+
        theme_bw()

plot.Rv.load.sp +  theme(legend.key=element_blank()) +theme(legend.text = element_text(face = "italic")) +theme(axis.text.x = element_text(angle=30, hjust=1,vjust=1)) + theme(axis.title = element_text(size=16))

```


?? **QUESTION** is it ok to do this? Or am I better often doing log(n+1)? My reasoning was that we are not interested in no infection!?


The distribution of logged Rv viral load.

```{r distribution Rv load, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.cap= "Fig. 4a. The  distribution of Rv load from endpoint tissue samples.", fig.width=16, fig.height=6}
data.endpoint %>%     # ridge plot to see distribution of data  
    filter(Rv.endpoint.load > 0 & !Rv.endpoint.load > 2000)  %>%  ggplot(aes(Rv.endpoint.load, Treatment)) +
      geom_density_ridges(
                      jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
                      vline_size = 1, vline_color = "red",
                      point_size = 0.4, point_alpha = 1,
                      position = position_raincloud(adjust_vlines = TRUE)
          ) + theme_ridges()
```

...and when Rv viral load is logged because the distribution of Rv load is skewed. 


```{r log distribution Rv load, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.cap= "Fig. 4b. The logged distribution of Rv load from endpoint tissue samples.", fig.width=16, fig.height=6}
data.endpoint %>%     # ridge plot to see distribution of data  
    filter(Rv.endpoint.load > 0 & !Rv.endpoint.load > 2000)  %>%  ggplot(aes(log(Rv.endpoint.load), Treatment)) +
      geom_density_ridges(
                      jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
                      vline_size = 1, vline_color = "red",
                      point_size = 0.4, point_alpha = 1,
                      position = position_raincloud(adjust_vlines = TRUE)
          ) + theme_ridges()
```


## Part 5: Endpoint Infection Status: **Rv** 

Here I create a dataframe with only individuals that am infected with Rv 

?? **QUESTION** is there a threshold for ranavirus infection ??? 

<br>
```{r Rv load df, results='hide', warning=FALSE, error=FALSE, message=FALSE}

Rv.load <- data.endpoint %>%
  filter((Rv.endpoint.load > 0.1))  %>% 
  select(ID, Species, ExperimentNo, Scenario, Treatment, Rv.MCPendpoint.status, Rv.EBF3Nendpoint.status, Rv.endpoint.load) 

droplevels(Rv.load)
```

### Model Selection:  

Choosing a error structure family. Again, I decided to do this with a semi-maximal model to help the fitting as much as possible. 


1. gaussian distribution with data log transformed  

```{r Rv log gaussian}
Rv.load2.1 <- glm(log(Rv.endpoint.load) ~ Treatment + ExperimentNo, data=Rv.load, family= "gaussian")
summary(Rv.load2.1)   #AIC = 76.262  #Residual deviance:  41.834  on 14  degrees of freedom

par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Rv.load2.1)
```
- residuals vs fitted:   
- QQ plot is not great, (not normally distributed?)
- residual vs. leverage reflects the data, low sample numbers means a few data points are influencing the model 

2. gaussian distribution with log link

```{r Rv gaussian log link}
Rv.load2.2 <- glm(Rv.endpoint.load ~ Treatment + ExperimentNo, data=Rv.load,family="gaussian"(link='log'))
summary(Rv.load2.2)   #AIC = 293.47  #Residual deviance:  7283161  on 14  degrees of freedom  degrees of freedom

par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Rv.load2.2)
```

Again, this is a terrible model 


3. Gamma distribution

```{r Rv Gamma }
# Gamma distribution
Rv.load2.3 <- glm(Rv.endpoint.load ~ Treatment + ExperimentNo, data=Rv.load, family=Gamma())
summary(Rv.load2.3)   #AIC = 257.35  #Residual deviance: 23.678  on 14  degrees of freedom

par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Rv.load2.3)
```
- residuals vs fitted: patterning  
- QQ plot is not great, (not normally distributed?)
- residual vs. leverage is better but still reflects the data, low sample numbers means a few data points are influencing the model 



4. Gamma distribution with log-link

```{r Rv Gamma log link}
Rv.load2.4 <- glm(Rv.endpoint.load ~ Treatment + ExperimentNo, data=Rv.load, family="Gamma"(link='log'))
summary(Rv.load2.4)   #AIC = 255.8  #Residual deviance: 22.027  on 14  degrees of freedom

par(mfrow=c(2,2), mar=c(3,3,3,1), mgp=c(2,0.8,0))
plot(Rv.load2.4)
```

?? **QUESTION** log(Rv load) and gaussian or Gamma? None of them look ideal 



### Model Comparison

The four models (all using log(Bd load) and gaussian error structure)
```{r Rv load glm}
Rv.load1 <- glm(log(Rv.endpoint.load) ~ Treatment * ExperimentNo, data=Rv.load, family=gaussian)

Rv.load2 <- glm(log(Rv.endpoint.load) ~ Treatment + ExperimentNo, data=Rv.load, family=gaussian)

Rv.load3 <- glm(log(Rv.endpoint.load) ~ Treatment, data=Rv.load, family=gaussian)

Rv.load4 <- glm(log(Rv.endpoint.load) ~ ExperimentNo, data=Rv.load, family=gaussian)
```

?? **QUESTION** should I change the `test = ` to better reflect the data type? 

```{r Rv load model comparison}

anova(Rv.load2, Rv.load4, test="Chisq") # compares Trt and Sp to just Sp 

anova(Rv.load2, Rv.load3, test="Chisq") # compares Trt and Sp to just Trt 

anova(Rv.load1, Rv.load2, test="Chisq") # compare more complex model to one with interaction 

```

ANOVA 1: suggests we should favour the more complex model (Treatment + ExperimentNo) over the model with ExperimentNo only  (pvalue = < .001)

ANOVA 2: suggests we should reject the more complex model (Treatment + ExperimentNo) in favour of the model with Treatment only  (pvalue = 0.6146)  as adding ExperimentNo didn't lead to significantly improved fit 

ANOVA 3: shows adding a interaction term between Treatment and ExperimentNo did not significantly imporve fit (p-value = 0.2214)

**Conclusion**: we should choose the model with just Treatment (like Rv status)


### Model Fit: 


```{r Rv fitted values, echo=FALSE, fig.cap= "Fig. 6. Plot of relationship between the fitted values from the model and the true data values."}

Rv.load$glm.fit <- Rv.load3$fitted.values  # add logisitic fitted values back to the dataframe as a new col

plot(x = Rv.load$Rv.endpoint.load, y = Rv.load$glm.fit,  # 
     xlab = "True Values",
     ylab = "Model Fitted Values",
     main = "Regression fits of Rv load")

abline(b = 1, a = 0)   # values should fall around this line!

```

Errmmmmm...... ?? 


### Model Plotting:   


```{r Rv - glm - predicted values, include=TRUE, warning=FALSE, error=FALSE, message=FALSE}
Rv.load3 <- glm(log(Rv.endpoint.load) ~ Treatment, data=Rv.load, family=gaussian)

# create a dataframe of "new" data 
newdat <- expand.grid(ExperimentNo=c("1", "2", "3", "4", "5"),Treatment=c( "Bd-Rv", "Rv-Bd"))

# predict the value/result of the new data using the glm
Rv.newdat <-cbind(newdat, predict(object = Rv.load3,   # the model 
                               newdata=newdat, se=TRUE, type="response", print.matrix=T))  # dataframe of new data 
Rv.newdat

expl.var <- c(1:2) # chose the range for the x-axis (Treatment)
exp.labs <- c("1" = "Bufo bufo I", "2" = "Bufo bufo II", "3" = "Rana temporaria", "4" = "Alytes muletensis I")

newdat1<- subset(Rv.newdat, ExperimentNo== "1")    # need to subset the data so you can plot each seperatly 
newdat2<- subset(Rv.newdat, ExperimentNo=="2")
newdat3<- subset(Rv.newdat, ExperimentNo=="3")
newdat4<- subset(Rv.newdat, ExperimentNo=="4")
```


```{r Rv - glm - plot, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.cap= "Fig. 7. Probability of Rv infection load predicted by model"}

Rv.load.predict <- ggplot(Rv.newdat, aes(x= expl.var, y= fit, color=ExperimentNo)) +       # plot model estimates, color= the data you subsetted by
  geom_line(data = newdat1, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat1
  geom_errorbar(data = newdat1, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1)  +      # error bars for subset newdat1
  geom_line(data = newdat2, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat2
  geom_errorbar(data = newdat2, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1)  +      # error bars for subset newdat2
  geom_line(data = newdat3, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat3
  geom_errorbar(data = newdat3, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1)  +      # error bars for subset newdat3
  geom_line(data = newdat4, aes(x= expl.var, y= fit), size=1) +                                   # add lines for subset newdat4
  geom_errorbar(data = newdat4, aes(ymin=fit-se.fit, ymax=fit+se.fit), width=.03, size=1) +       # error bars for subset newdat4
    scale_x_continuous(breaks=seq(1:2),labels=c("Bd-Rv","Rv-Bd")) +   # sets the breaks at 1,2 and 3 which correspond to the label names
  ggtitle("glm(Rv.endpoint.load ~ ExperimentNo,family = gaussian)") 
      
Rv.load.predict <- Rv.load.predict + 
  ylab("Rv load predictions\n(fit)") +            
  xlab("Treatment Group") +
  scale_fill_discrete(labels=exp.labs) +  # still not working!!!
  theme_bw() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) 

Rv.load.predict

#  ggsave("figs/04_Rv_load-predict.png", plot= Rv.load.predict, device=NULL)
 
```







################### SCRAPS ################### SCRAPS ################### SCRAPS ################### SCRAPS ################### SCRAPS ################### SCRAPS ################### SCRAPS ###################

# Part 4: other bits




# ANOVA of linear regression terms 
look at the terms of the model using the anova function
ANOVA tests how much variation in the response variable is explained by each explanatory variable
aka comparing the variation in ge score explained by treamtent (or another variable) to the total variation in ge score (the null model). 
Look at how much smaller the residuals are for the treatment group model to the null model. Graphically, how much shorter are the red residuals than
the blue residuals



ANOVA (one-way) 

y= ß1 + ß2xs + ß3xa   
  ...where  
          - baseline value (control) is 